{% extends "base.html" %}

{% block title %}Your Habit Plan - AI Habit Assistant{% endblock %}

{% block content %}
<!-- Results Header -->
<section class="results-header py-5 bg-gradient-primary">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center text-white">
                <div class="success-icon mb-3">
                    <i class="bi bi-check-circle-fill display-4"></i>
                </div>
                <h1 class="display-5 fw-bold mb-3">Your Personalized Habit Plan is Ready!</h1>
                <p class="lead mb-4">Here's your AI-generated 7-day plan to build these habits:</p>
                <div class="habits-list d-flex flex-wrap justify-content-center gap-2">
                    {% for habit in habits %}
                        <span class="badge bg-light text-dark fs-6 px-3 py-2">
                            <i class="bi bi-star-fill me-1"></i>{{ habit | e }}
                        </span>
                    {% endfor %}
                </div>
                <div class="mt-4">
                    <button type="button" id="print-plan" class="btn btn-outline-light me-2">
                        <i class="bi bi-printer me-1"></i>Print Plan
                    </button>
                    <a href="{{ url_for('new_plan') }}" class="btn btn-light">
                        <i class="bi bi-plus-circle me-1"></i>Create New Plan
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Plan Overview -->
{% if plan and plan.overview %}
<section class="plan-overview py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="overview-card">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-lightbulb-fill text-warning fs-4 me-2"></i>
                        <h3 class="mb-0">Plan Overview</h3>
                    </div>
                    <p class="lead mb-0">{{ plan.overview | e }}</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Daily Plans -->
<section class="daily-plans py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="section-header text-center mb-5">
                    <h2 class="section-title">Your 7-Day Journey</h2>
                    <p class="section-subtitle">Follow this day-by-day guide to build lasting habits</p>
                </div>

                {% if plan and plan.days %}
                {% for day in plan.days %}
                <div class="day-card mb-4" data-day="{{ day.day }}" data-animation-delay="{{ loop.index0 * 100 }}">
                    <div class="day-header">
                        <div class="day-number">
                            <span class="day-num">{{ day.day }}</span>
                        </div>
                        <div class="day-info">
                            <h3 class="day-title">{{ day.date_label | e }}</h3>
                            {% if day.daily_tip %}
                                <p class="day-tip">
                                    <i class="bi bi-emoji-smile text-warning me-1"></i>
                                    {{ day.daily_tip | e }}
                                </p>
                            {% endif %}
                        </div>
                        <div class="day-toggle">
                            <button type="button" class="btn btn-outline-primary btn-sm toggle-day" 
                                    data-toggle-day="{{ day.day }}">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                    </div>

                    <div class="day-content" id="day-content-{{ day.day }}">
                        <div class="row g-3">
                            {% if day.habits %}
                            {% for habit_detail in day.habits %}
                            <div class="col-md-6 col-lg-4">
                                <div class="habit-task-card" data-habit-id="{{ day.day }}|||{{ habit_detail.habit | e }}">
                                    <div class="habit-task-header">
                                        <i class="bi bi-target habit-icon"></i>
                                        <h5 class="habit-name">{{ habit_detail.habit | e }}</h5>
                                    </div>
                                    <div class="habit-task-body">
                                        <div class="task-section">
                                            <h6 class="task-label">
                                                <i class="bi bi-clipboard-check me-1"></i>Today's Task
                                            </h6>
                                            <p class="task-text">{{ habit_detail.task | e }}</p>
                                        </div>
                                        {% if habit_detail.motivation %}
                                        <div class="motivation-section">
                                            <h6 class="motivation-label">
                                                <i class="bi bi-heart-fill me-1"></i>Motivation
                                            </h6>
                                            <p class="motivation-text">{{ habit_detail.motivation | e }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="habit-task-footer">
                                        <button type="button" class="btn btn-sm btn-outline-success complete-task">
                                            <i class="bi bi-check me-1"></i>Mark Complete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Progress Section -->
<section class="progress-section py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="progress-card">
                    <h4 class="mb-3">
                        <i class="bi bi-graph-up text-success me-2"></i>Track Your Progress
                    </h4>
                    <div class="progress-stats">
                        <div class="stat">
                            <div class="stat-value" id="completed-tasks">0</div>
                            <div class="stat-label">Tasks Completed</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="completion-rate">0%</div>
                            <div class="stat-label">Completion Rate</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">{{ plan.days|length if plan and plan.days else 0 }}</div>
                            <div class="stat-label">Days to Go</div>
                        </div>
                    </div>
                    <div class="progress mt-3">
                        <div class="progress-bar bg-success" id="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Tips Section -->
<section class="tips-section py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="tips-card">
                    <h4 class="mb-4">
                        <i class="bi bi-lightbulb text-warning me-2"></i>Pro Tips for Success
                    </h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="tip-item">
                                <i class="bi bi-alarm text-primary me-2"></i><strong>Set Reminders:</strong> Use alarms or habit apps to stay on track.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tip-item">
                                <i class="bi bi-people text-success me-2"></i><strong>Find Accountability:</strong> Share your progress with others.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tip-item">
                                <i class="bi bi-award text-warning me-2"></i><strong>Celebrate Wins:</strong> Recognize your consistency and progress.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tip-item">
                                <i class="bi bi-arrow-clockwise text-info me-2"></i><strong>Stay Consistent:</strong> Small daily efforts compound into big changes.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Hidden data container for JavaScript -->
<div id="plan-data" style="display: none;"
     data-days-count="{{ plan.days|length if plan and plan.days else 0 }}"
     data-habits-count="{{ habits|length if habits else 0 }}">
</div>
{% endblock %}

{% block scripts %}
<script>
// Get data from DOM data attributes
const planDataEl = document.getElementById('plan-data');
const daysCount = parseInt(planDataEl.dataset.daysCount) || 0;
const habitsCount = parseInt(planDataEl.dataset.habitsCount) || 0;

// Initialize variables with safe defaults
let completedTasks = 0;
const totalTasks = daysCount * habitsCount;
const animationTimeouts = [];

// Utility functions
function isLocalStorageAvailable() {
    try {
        const test = '__localStorage_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
    } catch(e) {
        return false;
    }
}

function safeQuerySelector(selector, parent) {
    try {
        return (parent || document).querySelector(selector);
    } catch(e) {
        console.warn('Query selector failed:', selector, e);
        return null;
    }
}

function safeQuerySelectorAll(selector, parent) {
    try {
        return (parent || document).querySelectorAll(selector);
    } catch(e) {
        console.warn('Query selector all failed:', selector, e);
        return [];
    }
}

// Main functions
function toggleDay(dayNumber) {
    if (!dayNumber) return;
    
    const content = safeQuerySelector('#day-content-' + dayNumber);
    const buttonIcon = safeQuerySelector('[data-toggle-day="' + dayNumber + '"] i');
    
    if (!content || !buttonIcon) return;
    
    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    buttonIcon.className = isHidden ? 'bi bi-chevron-down' : 'bi bi-chevron-right';
}

function completeTask(button) {
    if (!button) return;
    
    const isCompleted = button.classList.contains('completed');
    
    // Update button state
    button.classList.toggle('completed');
    
    if (isCompleted) {
        button.innerHTML = '<i class="bi bi-check me-1"></i>Mark Complete';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-success');
    } else {
        button.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Completed!';
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
    }

    // Update completion count
    completedTasks += isCompleted ? -1 : 1;
    updateProgress();

    // Visual feedback for completion
    if (!isCompleted) {
        const card = button.closest('.habit-task-card');
        if (card) {
            card.classList.add('task-completed');
            setTimeout(function() {
                card.classList.remove('task-completed');
            }, 1000);
        }
    }
}

function updateProgress() {
    const completedTasksEl = document.getElementById('completed-tasks');
    const completionRateEl = document.getElementById('completion-rate');
    const progressBar = document.getElementById('progress-bar');
    
    if (totalTasks === 0) {
        if (completedTasksEl) completedTasksEl.textContent = '0';
        if (completionRateEl) completionRateEl.textContent = '0%';
        return;
    }

    const completionRate = Math.round((completedTasks / totalTasks) * 100);
    
    if (completedTasksEl) completedTasksEl.textContent = completedTasks;
    if (completionRateEl) completionRateEl.textContent = completionRate + '%';
    
    if (progressBar) {
        progressBar.style.width = completionRate + '%';
        progressBar.setAttribute('aria-valuenow', completionRate);
        
        // Update progress bar color based on completion rate
        progressBar.className = 'progress-bar ' + 
            (completionRate < 30 ? 'bg-danger' : 
             completionRate < 70 ? 'bg-warning' : 'bg-success');
    }
}

function saveProgress() {
    if (!isLocalStorageAvailable()) return;
    
    try {
        const progress = {
            completedTasks: completedTasks,
            completedButtons: []
        };

        const completedButtons = safeQuerySelectorAll('.complete-task.completed');
        for (let i = 0; i < completedButtons.length; i++) {
            const button = completedButtons[i];
            const card = button.closest('.habit-task-card');
            if (card && card.dataset.habitId) {
                progress.completedButtons.push(card.dataset.habitId);
            }
        }

        localStorage.setItem('habitProgress', JSON.stringify(progress));
    } catch(e) {
        console.warn('Failed to save progress:', e);
    }
}

function loadProgress() {
    if (!isLocalStorageAvailable()) return;
    
    try {
        const saved = localStorage.getItem('habitProgress');
        if (!saved) return;

        const progress = JSON.parse(saved);
        
        if (progress.completedButtons && Array.isArray(progress.completedButtons)) {
            for (let i = 0; i < progress.completedButtons.length; i++) {
                const habitId = progress.completedButtons[i];
                const card = safeQuerySelector('[data-habit-id="' + habitId + '"]');
                if (card) {
                    const button = card.querySelector('.complete-task');
                    if (button && !button.classList.contains('completed')) {
                        completeTask(button);
                    }
                }
            }
        }
    } catch(e) {
        console.warn('Failed to load progress:', e);
    }
}

function initializeAnimations() {
    const dayCards = safeQuerySelectorAll('.day-card');
    
    for (let i = 0; i < dayCards.length; i++) {
        const card = dayCards[i];
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        const delay = parseInt(card.dataset.animationDelay) || (i * 100);
        const timeout = setTimeout(function() {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, delay);
        
        animationTimeouts.push(timeout);
    }
}

function initializeDayStates() {
    const dayContents = safeQuerySelectorAll('[id^="day-content-"]');
    const toggleButtons = safeQuerySelectorAll('[data-toggle-day] i');
    
    // Hide all days initially
    for (let i = 0; i < dayContents.length; i++) {
        dayContents[i].style.display = 'none';
    }
    
    // Set all toggle buttons to right chevron
    for (let i = 0; i < toggleButtons.length; i++) {
        toggleButtons[i].className = 'bi bi-chevron-right';
    }
    
    // Show first day by default
    toggleDay(1);
}

function cleanup() {
    // Clear any pending animation timeouts
    for (let i = 0; i < animationTimeouts.length; i++) {
        clearTimeout(animationTimeouts[i]);
    }
    animationTimeouts.length = 0;
}

// Event listeners
function attachEventListeners() {
    // Print button
    const printButton = document.getElementById('print-plan');
    if (printButton) {
        printButton.addEventListener('click', function() {
            window.print();
        });
    }

    // Day toggle buttons (using event delegation)
    document.addEventListener('click', function(e) {
        const toggleButton = e.target.closest('[data-toggle-day]');
        if (toggleButton) {
            e.preventDefault();
            const dayNumber = parseInt(toggleButton.dataset.toggleDay);
            if (!isNaN(dayNumber)) {
                toggleDay(dayNumber);
            }
        }
    });

    // Complete task buttons (using event delegation)
    document.addEventListener('click', function(e) {
        const completeButton = e.target.closest('.complete-task');
        if (completeButton) {
            e.preventDefault();
            completeTask(completeButton);
            // Save progress after a short delay to ensure state is updated
            setTimeout(saveProgress, 100);
        }
    });
}

// Page cleanup on unload
window.addEventListener('beforeunload', cleanup);

// Initialize everything when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    try {
        initializeDayStates();
        loadProgress();
        initializeAnimations();
        attachEventListeners();
    } catch(e) {
        console.error('Initialization failed:', e);
    }
});
</script>
{% endblock %}